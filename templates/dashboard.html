{% extends "base.html" %}

{% block title %}Ana Panel{% endblock %}

{% block extra_head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="row g-4">
    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header bg-dark text-white"><h5 class="mb-0"><i class="fa-solid fa-chart-line me-2"></i>Bu Ayın Nakit Akışı</h5></div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2"><span><i class="fa-solid fa-arrow-up text-success"></i> Beklenen Gelir</span><strong class="text-success fs-5">{{ "%.2f"|format(monthly_cash_flow.income) }} ₺</strong></div>
                <div class="d-flex justify-content-between align-items-center mb-3"><span><i class="fa-solid fa-arrow-down text-danger"></i> Planlanan Gider</span><strong class="text-danger fs-5">{{ "%.2f"|format(monthly_cash_flow.expense) }} ₺</strong></div>
                <hr>
                <div class="d-flex justify-content-between align-items-center fw-bold"><span>Net Nakit Akışı</span><span class="fs-4 {% if monthly_cash_flow.net < 0 %}text-danger{% else %}text-success{% endif %}">{{ "%.2f"|format(monthly_cash_flow.net) }} ₺</span></div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-danger text-white"><h5 class="mb-0"><i class="fa-solid fa-triangle-exclamation me-2"></i>Geciken Müşteri Ödemeleri ({{ overdue_customer_payments|length }})</h5></div>
            <ul class="list-group list-group-flush">
                {% for fn, ln, due_date, remaining in overdue_customer_payments %}<li class="list-group-item d-flex justify-content-between align-items-center"><div><strong>{{ fn }} {{ ln }}</strong><br><small class="text-muted">{{ due_date.strftime('%d.%m.%Y') }}</small></div><span class="badge bg-danger rounded-pill fs-6">{{ "%.2f"|format(remaining) }} ₺</span></li>{% else %}<li class="list-group-item text-center text-muted p-3">Gecikmiş müşteri ödemesi yok.</li>{% endfor %}
            </ul>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-warning text-dark"><h5 class="mb-0"><i class="fa-solid fa-clock me-2"></i>Yaklaşan Müşteri Ödemeleri ({{ upcoming_customer_payments|length }})</h5></div>
            <ul class="list-group list-group-flush">
                {% for fn, ln, due_date, remaining in upcoming_customer_payments %}<li class="list-group-item d-flex justify-content-between align-items-center"><div><strong>{{ fn }} {{ ln }}</strong><br><small class="text-muted">{{ due_date.strftime('%d.%m.%Y') }}</small></div><span class="badge bg-warning text-dark rounded-pill fs-6">{{ "%.2f"|format(remaining) }} ₺</span></li>{% else %}<li class="list-group-item text-center text-muted p-3">Yaklaşan müşteri ödemesi yok.</li>{% endfor %}
            </ul>
        </div>
        
        <div class="card mb-4">
            <div class="card-header bg-danger text-white"><h5 class="mb-0"><i class="fa-solid fa-arrow-up-from-bracket me-2"></i>Geciken Gider Ödemeleri ({{ overdue_expense_payments|length }})</h5></div>
            <ul class="list-group list-group-flush">
                {% for s_name, due_date, remaining, p_name in overdue_expense_payments %}<li class="list-group-item d-flex justify-content-between align-items-center"><div><strong>{{ s_name }}</strong><br><small class="text-muted">{{ p_name }}</small></div><span class="badge bg-danger rounded-pill fs-6">{{ "%.2f"|format(remaining) }} ₺</span></li>{% else %}<li class="list-group-item text-center text-muted p-3">Gecikmiş gider ödemesi yok.</li>{% endfor %}
            </ul>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-warning text-dark"><h5 class="mb-0"><i class="fa-solid fa-hourglass-start me-2"></i>Yaklaşan Gider Ödemeleri ({{ upcoming_expense_payments|length }})</h5></div>
            <ul class="list-group list-group-flush">
                {% for s_name, due_date, remaining, p_name in upcoming_expense_payments %}<li class="list-group-item d-flex justify-content-between align-items-center"><div><strong>{{ s_name }}</strong><br><small class="text-muted">{{ p_name }}</small></div><span class="badge bg-warning text-dark rounded-pill fs-6">{{ "%.2f"|format(remaining) }} ₺</span></li>{% else %}<li class="list-group-item text-center text-muted p-3">Yaklaşan gider ödemesi yok.</li>{% endfor %}
            </ul>
        </div>

        <div class="card">
             <div class="card-header"><h5 class="mb-0"><i class="fa-solid fa-money-check-dollar me-2"></i>Vadesi Yaklaşan Çekler (30 Gün)</h5></div>
             <div class="card-body">
                <h6><i class="fa-solid fa-arrow-down text-success"></i> Alınacak Çekler</h6>
                <ul class="list-group list-group-flush mb-3">
                    {% for due_date, amount, c_name in upcoming_incoming_checks %}<li class="list-group-item d-flex justify-content-between align-items-center"><span>{{ c_name }}</span> <span>{{ due_date.strftime('%d.%m.%Y') }} - <strong class="text-success">{{ "%.2f"|format(amount) }} ₺</strong></span></li>{% else %}<li class="list-group-item text-muted text-center">Yaklaşan müşteri çeki yok.</li>{% endfor %}
                </ul>
                <h6><i class="fa-solid fa-arrow-up text-danger"></i> Verilecek Çekler</h6>
                <ul class="list-group list-group-flush">
                    {% for due_date, amount, s_name in upcoming_outgoing_checks %}<li class="list-group-item d-flex justify-content-between align-items-center"><span>{{ s_name }}</span> <span>{{ due_date.strftime('%d.%m.%Y') }} - <strong class="text-danger">{{ "%.2f"|format(amount) }} ₺</strong></span></li>{% else %}<li class="list-group-item text-muted text-center">Yaklaşan firma çeki yok.</li>{% endfor %}
                </ul>
             </div>
        </div>

    </div>

    <div class="col-lg-8">
        <div class="row g-4 mb-4">
            <div class="col-6"><div class="card text-center p-3"><i class="fa-solid fa-users fa-2x text-primary mb-2"></i><h6 class="text-muted small">Toplam Müşteri</h6><h4 class="fw-bold">{{ total_customers }}</h4></div></div>
            <div class="col-6"><div class="card text-center p-3"><i class="fa-solid fa-building fa-2x text-success mb-2"></i><h6 class="text-muted small">Toplam Daire</h6><h4 class="fw-bold">{{ total_flats }}</h4></div></div>
        </div>
        <div class="card mb-4">
            <div class="card-header"><h5 class="mb-0">Aylık Tahsilat Grafiği (Son 12 Ay)</h5></div>
            <div class="card-body p-4"><div style="height: 250px;"><canvas id="monthlyPaymentsChart"></canvas></div></div>
        </div>
        
        <div class="card">
            <div class="card-header"><h5 class="mb-0">Projeler</h5></div>
            <div class="card-body">
                <div class="list-group">
                    {% for project in projects %}
                    <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center flex-wrap">
                        <div class="mb-2 mb-md-0">
                            <h5 class="mb-1">{{ project.name }}</h5>
                            <small class="badge {% if project.project_type == 'normal' %} bg-primary {% else %} bg-success {% endif %}">{{ project.project_type }}</small>
                        </div>
                        <div class="btn-group" role="group">
                            <a href="{{ url_for('list_expenses', project_id=project.id) }}" class="btn btn-outline-primary btn-sm"><i class="fa-solid fa-file-invoice-dollar me-1"></i> Giderler</a>
                            <a href="{{ url_for('edit_project', project_id=project.id) }}" class="btn btn-outline-warning btn-sm"><i class="fa-solid fa-pencil me-1"></i> Düzenle</a>
                            <form action="{{ url_for('delete_project', project_id=project.id) }}" method="POST" class="d-inline">
                                <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Bu projeyi ve tüm alt verilerini silmek istediğinizden emin misiniz?')"><i class="fa-solid fa-trash-alt me-1"></i> Sil</button>
                            </form>
                        </div>
                    </div>
                    {% else %}
                    <p class="text-center text-muted p-3">Henüz proje oluşturulmamış.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        fetch('/api/monthly_payments')
            .then(response => response.json())
            .then(apiData => {
                const ctx = document.getElementById('monthlyPaymentsChart').getContext('2d');
                const turkishLabels = apiData.labels.map(isoDateString => {
                    const date = new Date(isoDateString);
                    return date.toLocaleDateString('tr-TR', { month: 'long', year: 'numeric' });
                });
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: turkishLabels,
                        datasets: [{
                            label: 'Aylık Tahsilat (₺)',
                            data: apiData.data,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1,
                            borderRadius: 5
                        }]
                    },
                    options: {
                        maintainAspectRatio: false,
                        responsive: true,
                        scales: { y: { beginAtZero: true, ticks: { callback: function(value) { return new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(value); } } } },
                        plugins: { legend: { display: false }, tooltip: { callbacks: { label: function(context) { let label = context.dataset.label || ''; if (label) { label += ': '; } if (context.parsed.y !== null) { label += new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(context.parsed.y); } return label; } } } }
                    }
                });
            })
            .catch(error => console.error('Grafik verisi yüklenirken hata oluştu:', error));
    });
</script>
{% endblock %}
