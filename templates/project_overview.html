{% extends "base.html" %}

{% block title %}{{ project_name }} - Finansal Zaman Çizelgesi{% endblock %}

{% block extra_head %}
<style>
    .summary-card h6 { font-size: 0.8rem; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold mb-0"><i class="fa-solid fa-timeline me-2 text-primary"></i>Finansal Zaman Çizelgesi</h2>
        <p class="text-muted fs-5">{{ project_name }} <span class="badge bg-secondary">{{ project_type|capitalize }}</span></p>
    </div>
    <div>
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
            <i class="fa-solid fa-arrow-left me-1"></i>Geri
        </a>
    </div>
</div>

<!-- ÖZET KARTI -->
<div class="card summary-card mb-4">
    <div class="card-body p-3">
        <div class="row align-items-center">
            <div class="col-md-6 border-end">
                <h5 class="text-center mb-3">Gelir Özeti</h5>
                {% if project_type == 'normal' %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span><i class="fa-solid fa-sack-dollar text-dark me-1"></i>Toplam Beklenen Gelir</span>
                    <strong class="text-dark fs-5">{{ (total_paid_income + total_unpaid_income)|thousands }} ₺</strong>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <span><i class="fa-solid fa-hourglass-half text-danger me-1"></i>Tahsil Edilecek Toplam</span>
                    <strong class="text-danger fs-5">{{ total_unpaid_income|thousands }} ₺</strong>
                </div>
                {% endif %}
                 <div class="d-flex justify-content-between align-items-center mt-2">
                    <span><i class="fa-solid fa-check-circle text-success me-1"></i>Tahsil Edilmiş Toplam</span>
                    <strong class="text-success fs-5">{{ total_paid_income|thousands }} ₺</strong>
                </div>
            </div>
            <div class="col-md-6">
                <h5 class="text-center mb-3">Gider Özeti</h5>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span><i class="fa-solid fa-file-invoice-dollar text-dark me-1"></i>Toplam Planlanan Gider</span>
                    <strong class="text-dark fs-5">{{ (total_paid_expense + total_unpaid_expense)|thousands }} ₺</strong>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <span><i class="fa-solid fa-hourglass-half text-danger me-1"></i>Kalan Borç Toplamı</span>
                    <strong class="text-danger fs-5">{{ total_unpaid_expense|thousands }} ₺</strong>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-2">
                    <span><i class="fa-solid fa-check-circle text-success me-1"></i>Ödenmiş Toplam</span>
                    <strong class="text-success fs-5">{{ total_paid_expense|thousands }} ₺</strong>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="filter-card mb-4">
    <form class="row g-3" method="get">
        <input type="hidden" name="sort_by" value="{{ sort_by }}">
        <input type="hidden" name="order" value="{{ order }}">
        <div class="col-md-4"><label class="form-label fw-semibold">Başlangıç Tarihi</label><input type="date" name="start_date" class="form-control" value="{{ start_date or '' }}"></div>
        <div class="col-md-4"><label class="form-label fw-semibold">Bitiş Tarihi</label><input type="date" name="end_date" class="form-control" value="{{ end_date or '' }}"></div>
        <div class="col-md-4 d-flex align-items-end">
            <button type="submit" class="btn btn-primary me-2"><i class="fa-solid fa-filter me-1"></i>Filtrele</button>
            <a href="{{ url_for('project_overview', project_id=project_id) }}" class="btn btn-outline-secondary"><i class="fa-solid fa-refresh me-1"></i>Temizle</a>
        </div>
    </form>
</div>

<div class="card mb-4">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0"><i class="fa-solid fa-arrow-down me-2"></i>
            {% if project_type == 'cooperative' %} Üye Katkı Payları {% else %} Planlanmış Gelirler (Müşteri Alacakları) {% endif %}
        </h5>
    </div>
    <div class="card-body table-responsive p-0">
        <!-- Verilen tabloya id ekleniyor: income-table -->
        <table id="income-table" class="table table-striped table-hover table-sm mb-0">
            <thead>
                <tr>
                    <th><a class="text-dark" href="{{ url_for('project_overview', project_id=project_id, sort_by='date', order='asc' if order == 'desc' else 'desc', start_date=start_date, end_date=end_date) }}">Tarih {% if sort_by == 'date' %}<i class="fa-solid fa-sort-{{ 'up' if order == 'asc' else 'down' }}"></i>{% endif %}</a></th>
                    <!-- "Kimden" bağlantısına id ve mevcut order bilgisini taşıyan dataset ekleniyor; ikon gösterimi de eklendi -->
                    <th>
                        <a id="sort-party-link" class="text-dark" data-order="{{ order|default('asc') }}" href="{{ url_for('project_overview', project_id=project_id, sort_by='party', order='asc' if order == 'desc' else 'desc', start_date=start_date, end_date=end_date) }}">
                            Kimden
                            {% if sort_by == 'party' %}
                                <i class="fa-solid fa-sort-{{ 'up' if order == 'asc' else 'down' }}" id="sort-party-icon"></i>
                            {% else %}
                                <i class="fa-solid fa-sort" id="sort-party-icon"></i>
                            {% endif %}
                        </a>
                    </th>
                    <!-- Daire sütunu: tıklanabilir -->
                    <th>
                        <a id="sort-flat-link" class="text-dark" data-order="asc" href="#">
                            Daire <i class="fa-solid fa-sort" id="sort-flat-icon"></i>
                        </a>
                    </th>
                    <th>Açıklama</th>
                    <!-- Durum sütunu: tıklanabilir -->
                    <th class="text-center">
                        <a id="sort-status-link" class="text-dark" data-order="asc" href="#">
                            Durum <i class="fa-solid fa-sort" id="sort-status-icon"></i>
                        </a>
                    </th>
                    <!-- Tutar sütunu: tıklanabilir, sayı olarak parse edilecek -->
                    <th class="text-end">
                        <a id="sort-amount-link" class="text-dark" data-order="asc" href="#">
                            Tutar <i class="fa-solid fa-sort" id="sort-amount-icon"></i>
                        </a>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for item in income_items %}
                <tr>
                    <td>{{ item.date.strftime('%d.%m.%Y') }}</td>
                    <td>{{ item.party }}</td>
                    <td class="small text-muted">{{ item.details }}</td>
                    <td>{{ item.description }}</td>
                    <td class="text-center"><span class="badge {{ item.status_class }}">{{ item.status }}</span></td>
                    <td class="text-end text-success fw-bold">{{ item.amount|thousands }} ₺</td>
                </tr>
                {% else %}
                <tr><td colspan="6" class="text-center text-muted p-3">Bu projeye ait gelir kaydı yok.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="card">
    <div class="card-header bg-danger text-white">
        <h5 class="mb-0"><i class="fa-solid fa-arrow-up me-2"></i>Planlanmış ve Nakit Giderler (Firma Borçları)</h5>
    </div>
    <div class="card-body table-responsive p-0">
        <table id="expense-table" class="table table-striped table-hover table-sm mb-0">
             <thead>
                 <tr>
                     <th><a class="text-dark" href="{{ url_for('project_overview', project_id=project_id, sort_by='date', order='asc' if order == 'desc' else 'desc', start_date=start_date, end_date=end_date) }}">Tarih {% if sort_by == 'date' %}<i class="fa-solid fa-sort-{{ 'up' if order == 'asc' else 'down' }}"></i>{% endif %}</a></th>
                     <th>Açıklama</th>
                     <th>Kime / Nereye</th>
                     <th class="text-center">
                        <a id="sort-expense-status" class="text-dark" data-order="asc" href="#">
                            Durum <i class="fa-solid fa-sort" id="sort-expense-status-icon"></i>
                        </a>
                    </th>
                    <th class="text-end">
                        <a id="sort-expense-amount" class="text-dark" data-order="asc" href="#">
                            Tutar <i class="fa-solid fa-sort" id="sort-expense-amount-icon"></i>
                        </a>
                    </th>
                 </tr>
             </thead>
             <tbody>
                 {% for item in expense_items %}
                 <tr>
                     <td>{{ item.date.strftime('%d.%m.%Y') }}</td>
                     <td>
                         <div>{{ item.description }}</div>
                         <div class="text-muted small">{{ item.details }}</div>
                     </td>
                     <td>{{ item.party }}</td>
                     <td class="text-center"><span class="badge {{ item.status_class }}">{{ item.status }}</span></td>
                     <td class="text-end text-danger fw-bold">{{ item.amount|thousands }} ₺</td>
                 </tr>
                 {% else %}
                 <tr><td colspan="5" class="text-center text-muted p-3">Bu projeye ait gider kaydı yok.</td></tr>
                 {% endfor %}
             </tbody>
         </table>
     </div>
 </div>
 
 <!-- JavaScript: gelişmiş istemci tarafı sıralama (metin, tarih, sayı) -->
 <script>
 document.addEventListener('DOMContentLoaded', function () {
     // Yardımcı: dd.mm.yyyy -> Date
     function parseDateDMY(text) {
         var parts = (text || '').trim().split('.');
         if (parts.length !== 3) return new Date(0);
         var d = parseInt(parts[0], 10), m = parseInt(parts[1], 10) - 1, y = parseInt(parts[2], 10);
         return new Date(y, m, d);
     }

     // Yardımcı: para metnini sayıya çevir (ör: "1.234.567 ₺" -> 1234567)
     function parseAmount(text) {
         var s = (text || '').trim();
         // remove currency and spaces
         s = s.replace(/[^\d\.,\-]/g, '');
         // if more than one dot and comma present, assume dots are thousands separators
         // standard approach: remove dots, replace comma with dot
         s = s.replace(/\./g, '').replace(/,/g, '.');
         var n = parseFloat(s);
         return isNaN(n) ? 0 : n;
     }

     // Genel attach fonksiyonu: tableId, linkId, colIndex, type ('text'|'date'|'number')
     function attachSort(linkId, tableId, colIndex, type) {
         var link = document.getElementById(linkId);
         var table = document.getElementById(tableId);
         if (!link || !table) return;
         var icon = link.querySelector('i');
         link.style.cursor = 'pointer';
         link.addEventListener('click', function (e) {
             e.preventDefault();
             var tbody = table.tBodies[0];
             if (!tbody) return;
             var rows = Array.prototype.slice.call(tbody.querySelectorAll('tr'));
             var currentOrder = (link.dataset.order || 'asc').toLowerCase();
             var newOrder = currentOrder === 'asc' ? 'desc' : 'asc';

             rows.sort(function (a, b) {
                 var aCell = a.cells[colIndex] ? a.cells[colIndex].textContent.trim() : '';
                 var bCell = b.cells[colIndex] ? b.cells[colIndex].textContent.trim() : '';
                 var cmp = 0;
                 if (type === 'date') {
                     cmp = parseDateDMY(aCell) - parseDateDMY(bCell);
                 } else if (type === 'number') {
                     cmp = parseAmount(aCell) - parseAmount(bCell);
                 } else { // 'text'
                     cmp = aCell.localeCompare(bCell, 'tr');
                 }
                 return newOrder === 'asc' ? cmp : -cmp;
             });

             rows.forEach(function (r) { tbody.appendChild(r); });
             link.dataset.order = newOrder;
             if (icon) {
                 icon.className = newOrder === 'asc' ? 'fa-solid fa-sort-up' : 'fa-solid fa-sort-down';
             }
         });
     }

     // Mevcut "Kimden" sıralaması için dataset'teki başlangıç yönünü koru
     // party column index = 1
     attachSort('sort-party-link', 'income-table', 1, 'text');

     // Daire (details) sütunu index = 2 (text)
     attachSort('sort-flat-link', 'income-table', 2, 'text');

     // Durum sütunu index = 4 (text, badge içeriği textContent ile alınır)
     attachSort('sort-status-link', 'income-table', 4, 'text');

     // Tutar sütunu index = 5 (number)
     attachSort('sort-amount-link', 'income-table', 5, 'number');

     // Expense table: Durum (col index 3, text), Tutar (col index 4, number)
     attachSort('sort-expense-status', 'expense-table', 3, 'text');
     attachSort('sort-expense-amount', 'expense-table', 4, 'number');
 });
 </script>
 {% endblock %}