<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daire Sahibi Ata</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top shadow">
        <div class="container">
        <a class="navbar-brand fw-bold" href="{{ url_for('dashboard') }}">
            <i class="fa-solid fa-building"></i> KONAK
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
            <li class="nav-item">
                <a class="nav-link active" href="{{ url_for('dashboard') }}">
                <i class="fa-solid fa-home me-1"></i>Ana Sayfa
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{{ url_for('new_payment') }}">
                <i class="fa-solid fa-plus me-1"></i>Yeni Ödeme
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{{ url_for('reports') }}">
                <i class="fa-solid fa-chart-line me-1"></i>Raporlar
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{{ url_for('debt_status') }}">
                <i class="fa-solid fa-exclamation-triangle me-1"></i>Borçlar
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{{ url_for('list_payments') }}">
                <i class="fa-solid fa-list me-1"></i>Tüm Ödemeler
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{{ url_for('new_project') }}">
                <i class="fa-solid fa-users me-1"></i>Yeni Proje
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{{ url_for('assign_flat_owner') }}">
                <i class="fa-solid fa-briefcase me-1"></i>Daire Atama
                </a>
            </ul>
            <div class="d-flex align-items-center">
            <span class="me-3">
                <i class="fa-solid fa-user me-1"></i>{{ user_name }}
            </span>
            <a href="{{ url_for('logout') }}" class="btn btn-danger btn-sm">
                <i class="fa-solid fa-sign-out-alt me-1"></i>Çıkış
            </a>
            </div>
        </div>
        </div>
    </nav>
<div class="container py-4" style="padding-top: 100px;">

{% extends "base.html" %}

{% block title %}Daire Sahibi Ata - KONAK İnşaat{% endblock %}

{% block content %}
<h3 class="mb-4">Daire Sahibi Ata</h3>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% for category, msg in messages %}
        <div class="alert alert-{{category}}">{{msg}}</div>
    {% endfor %}
{% endwith %}

<form method="POST" id="assignFlatForm">
    <div class="mb-3">
        <label for="projectSelect" class="form-label">Proje Seçin</label>
        <select class="form-select" id="projectSelect" name="project_id" required>
            <option value="">Proje Seçiniz</option>
            {% for project in projects %}
                <option value="{{ project[0] }}">{{ project[1] }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="mb-3">
        <label for="flatSelect" class="form-label">Daire Seçin (Projeye göre filtrelenir)</label>
        <select class="form-select" id="flatSelect" name="flat_id" required disabled>
            <option value="">Lütfen önce bir proje seçin</option>
        </select>
    </div>

    <div class="mb-3">
        <label class="form-label">Müşteri Bilgileri</label>
        <div class="form-check">
            <input class="form-check-input" type="radio" name="customer_option" id="existingCustomerRadio" value="existing" checked>
            <label class="form-check-label" for="existingCustomerRadio">
                Mevcut Müşteri Seç
            </label>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="radio" name="customer_option" id="newCustomerRadio" value="new">
            <label class="form-check-label" for="newCustomerRadio">
                Yeni Müşteri Ekle
            </label>
        </div>
    </div>

    <div id="existingCustomerFields">
        <div class="mb-3">
            <label for="customerSelect" class="form-label">Mevcut Müşteri</label>
            <select class="form-select" id="customerSelect" name="customer_id" required>
                <option value="">Müşteri Seçiniz</option>
                {% for customer in customers %}
                    <option value="{{ customer[0] }}">{{ customer[1] }} {{ customer[2] }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div id="newCustomerFields" style="display: none;">
        <div class="mb-3">
            <label for="new_first_name" class="form-label">Yeni Müşteri Adı</label>
            <input type="text" class="form-control" id="new_first_name" name="new_first_name">
        </div>
        <div class="mb-3">
            <label for="new_last_name" class="form-label">Yeni Müşteri Soyadı</label>
            <input type="text" class="form-control" id="new_last_name" name="new_last_name">
        </div>
        <div class="mb-3">
            <label for="new_phone" class="form-label">Telefon Numarası (Opsiyonel)</label>
            <input type="text" class="form-control" id="new_phone" name="new_phone">
        </div>
        <div class="mb-3">
            <label for="new_national_id" class="form-label">TC Kimlik/Vergi No (Opsiyonel)</label>
            <input type="text" class="form-control" id="new_national_id" name="new_national_id">
        </div>
    </div>
    
    <button type="submit" class="btn btn-primary">Sahibi Ata</button>
</form>

<hr class="my-4">

<h4>Mevcut Daire Sahipleri</h4>
<table class="table table-bordered table-striped">
    <thead>
        <tr>
            <th>Proje Adı</th>
            <th>Daire No</th>
            <th>Kat</th>
            <th>Mevcut Sahip</th>
            <th>İşlem</th>
        </tr>
    </thead>
    <tbody>
        {% for flat in flats_with_owners %}
        <tr>
            <td>{{ flat[1] }}</td>
            <td>{{ flat[2] }}</td>
            <td>{{ flat[3] }}</td>
            <td>{{ flat[4] if flat[4] else 'Sahipsiz' }} {{ flat[5] if flat[5] else '' }}</td>
            <td>
                <button class="btn btn-sm btn-outline-info edit-btn" 
                        data-flat-id="{{ flat[0] }}"
                        data-project-name="{{ flat[1] }}"
                        data-flat-no="{{ flat[2] }}"
                        data-floor="{{ flat[3] }}"
                        data-owner-id="{{ flat[6] if flat[6] is not none else '' }}"
                        data-owner-first-name="{{ flat[4] if flat[4] is not none else '' }}"
                        data-owner-last-name="{{ flat[5] if flat[5] is not none else '' }}"
                        data-owner-phone="{{ flat[7] if flat[7] is not none else '' }}"
                        data-owner-national-id="{{ flat[8] if flat[8] is not none else '' }}">
                    Düzenle
                </button>
                <button class="btn btn-sm btn-danger delete-owner-btn" 
                        data-flat-id="{{ flat[0] }}"
                        data-bs-toggle="modal" data-bs-target="#deleteConfirmationModal">
                    Müşteriyi Sil
                </button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmationModalLabel">Onay Gerekli</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Bu dairenin sahibini ve tüm ilgili ödeme/taksit bilgilerini silmek istediğinizden emin misiniz? Bu işlem geri alınamaz!
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Silmeyi Onayla</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // HTML elemanlarına erişim
    const projectSelect = document.getElementById('projectSelect');
    const flatSelect = document.getElementById('flatSelect');
    const newFirstNameInput = document.getElementById('new_first_name');
    const newLastNameInput = document.getElementById('new_last_name');
    const newPhoneInput = document.getElementById('new_phone');
    const newNationalIdInput = document.getElementById('new_national_id');
    const customerSelect = document.getElementById('customerSelect'); // Mevcut müşteri dropdown'ı

    // Müşteri seçimi radyo butonları ve alanları
    const existingCustomerRadio = document.getElementById('existingCustomerRadio');
    const newCustomerRadio = document.getElementById('newCustomerRadio');
    const existingCustomerFields = document.getElementById('existingCustomerFields');
    const newCustomerFields = document.getElementById('newCustomerFields');


    // Silme modalı ve onay butonu
    const deleteConfirmationModal = new bootstrap.Modal(document.getElementById('deleteConfirmationModal'));
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    let flatIdToDelete = null; // Silinecek daire ID'sini tutacak değişken

    // Flask'tan Jinja2 ile gelen proje ve daire verilerini JavaScript objesine dönüştürür
    const allFlatsData = [
        {% for project in projects %}
            { 
                id: {{ project[0] }}, 
                name: "{{ project[1] }}", 
                flats: [
                    {% for flat in flats_with_owners if flat[1] == project[1] %}
                        { 
                            id: {{ flat[0] }}, 
                            flat_no: {{ flat[2] }}, 
                            floor: {{ flat[3] }}, 
                            current_owner_id: {{ flat[6] if flat[6] is not none else 'null' }},
                            owner_first_name: "{{ flat[4] if flat[4] is not none else '' }}",
                            owner_last_name: "{{ flat[5] if flat[5] is not none else '' }}",
                            owner_phone: "{{ flat[7] if flat[7] is not none else '' }}",
                            owner_national_id: "{{ flat[8] if flat[8] is not none else '' }}"
                        },
                    {% endfor %}
                ]
            },
        {% endfor %}
    ];
    const allFlats = allFlatsData; 

    // Müşteri listesini JavaScript'e aktar (düzenleme için kullanılacak)
    const allCustomers = [
        {% for customer in customers %}
            { id: {{ customer[0] }}, first_name: "{{ customer[1] }}", last_name: "{{ customer[2] }}" },
        {% endfor %}
    ];

    // Müşteri seçeneği değiştiğinde alanları göster/gizle ve zorunlulukları ayarla
    function toggleCustomerFields() {
        if (existingCustomerRadio.checked) {
            existingCustomerFields.style.display = 'block';
            newCustomerFields.style.display = 'none';
            customerSelect.setAttribute('required', 'required');
            newFirstNameInput.removeAttribute('required');
            newLastNameInput.removeAttribute('required');
            // Yeni müşteri alanlarını temizle
            newFirstNameInput.value = '';
            newLastNameInput.value = '';
            newPhoneInput.value = '';
            newNationalIdInput.value = '';
        } else {
            existingCustomerFields.style.display = 'none';
            newCustomerFields.style.display = 'block';
            customerSelect.removeAttribute('required');
            newFirstNameInput.setAttribute('required', 'required');
            newLastNameInput.setAttribute('required', 'required');
            // Mevcut müşteri seçimini temizle
            customerSelect.value = '';
        }
    }

    existingCustomerRadio.addEventListener('change', toggleCustomerFields);
    newCustomerRadio.addEventListener('change', toggleCustomerFields);

    // Sayfa yüklendiğinde başlangıç durumunu ayarla
    document.addEventListener('DOMContentLoaded', toggleCustomerFields);


    projectSelect.addEventListener('change', function() {
        const selectedProjectId = this.value;
        flatSelect.innerHTML = '<option value="">Daire Seçiniz</option>'; // Daire listesini temizle
        flatSelect.disabled = true; // Daire seçimi pasif yap

        if (selectedProjectId) {
            // Seçilen projeyi allFlats dizisinden bul
            const selectedProject = allFlats.find(p => p.id == selectedProjectId);
            if (selectedProject && selectedProject.flats.length > 0) {
                // Projeye ait daireleri dropdown'a ekle
                selectedProject.flats.forEach(flat => {
                    const option = document.createElement('option');
                    option.value = flat.id;
                    option.textContent = `Daire No: ${flat.flat_no}, Kat: ${flat.floor}`;
                    flatSelect.appendChild(option);
                });
                flatSelect.disabled = false; // Daire seçimini aktif yap
            } else {
                flatSelect.innerHTML = '<option value="">Bu projede daire bulunmuyor</option>';
            }
        }
    });

    // Düzenleme butonu tıklama olayını dinle
    document.querySelectorAll('.edit-btn').forEach(button => {
        button.addEventListener('click', function() {
            // Butonun data- niteliklerinden bilgileri al
            const flatId = this.dataset.flatId;
            const projectName = this.dataset.projectName;
            const ownerId = this.dataset.ownerId; 
            const ownerFirstName = this.dataset.ownerFirstName;
            const ownerLastName = this.dataset.ownerLastName;
            const ownerPhone = this.dataset.ownerPhone;
            const ownerNationalId = this.dataset.ownerNationalId;

            // Proje seçimini formda ayarla
            projectSelect.value = allFlats.find(p => p.name === projectName)?.id || '';
            // Proje seçimi değiştikten sonra dairelerin yüklenmesi için change event'ini tetikle
            projectSelect.dispatchEvent(new Event('change')); 
            
            // Daire seçimini formda ayarla (Daireler yüklendikten sonra çalışması için gecikme)
            setTimeout(() => {
                flatSelect.value = flatId;
            }, 150); // 150ms gecikme, dairelerin dropdown'a doldurulması için yeterli olmalı

            // Müşteri bilgilerini doldur
            if (ownerId && ownerId !== 'null' && ownerId !== '') { // Sahip atanmışsa
                existingCustomerRadio.checked = true;
                toggleCustomerFields(); // Alanları güncelle
                customerSelect.value = ownerId; // Mevcut müşteriyi seç
                // Yeni müşteri alanlarını temizle (zaten toggleCustomerFields içinde yapılıyor)
            } else { // Sahipsizse veya yeni atanacaksa
                newCustomerRadio.checked = true; // Yeni müşteri ekle seçeneğini işaretle
                toggleCustomerFields(); // Alanları güncelle
                newFirstNameInput.value = ''; // Alanları temizle
                newLastNameInput.value = '';
                newPhoneInput.value = '';
                newNationalIdInput.value = '';
            }
            newFirstNameInput.value = ownerFirstName;
            newLastNameInput.value = ownerLastName;
            newPhoneInput.value = ownerPhone;
            newNationalIdInput.value = ownerNationalId;
        });
    });

    // Silme butonu tıklama olayını dinle (Modalı açar)
    document.querySelectorAll('.delete-owner-btn').forEach(button => {
        button.addEventListener('click', function() {
            flatIdToDelete = this.dataset.flatId; // Silinecek daire ID'sini kaydet
            deleteConfirmationModal.show(); // Modalı göster
        });
    });

    // Modal içindeki "Silmeyi Onayla" butonuna tıklama olayını dinle
    confirmDeleteBtn.addEventListener('click', function() {
        deleteConfirmationModal.hide(); // Modalı kapat

        if (flatIdToDelete) {
            fetch('/delete_flat_owner_data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ flat_id: flatIdToDelete }),
            })
            .then(response => {
                // Yanıtın başarılı olup olmadığını kontrol et (HTTP 2xx)
                if (!response.ok) {
                    // Eğer yanıt başarılı değilse, hatayı yakala ve mesajı göster
                    return response.text().then(text => {
                        console.error('Sunucu yanıt hatası:', text);
                        throw new Error(`HTTP Hata! Durum: ${response.status}, Mesaj: ${text.substring(0, 100)}...`); // İlk 100 karakteri göster
                    });
                }
                // Yanıtın JSON olup olmadığını kontrol et
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    return response.json();
                } else {
                    // Eğer JSON değilse ama başarılıysa, uyarı ver ve yine de sayfayı yenile
                    console.warn("Sunucu yanıtı JSON değil, ancak durum başarılıydı.");
                    return response.text().then(text => ({ success: true, message: "İşlem başarılı, ancak sunucudan JSON yanıtı alınamadı. Ham Yanıt: " + text.substring(0, 100) }));
                }
            })
            .then(data => {
                if (data.success) {
                    alert(data.message); // Başarı mesajı
                } else {
                    alert('Hata: ' + data.message); // Hata mesajı
                }
            })
            .catch(error => {
                console.error('Silme işleminde beklenmeyen hata:', error);
                alert('Silme işlemi sırasında bir hata oluştu: ' + error.message); // Gerçek hata mesajını göster
            })
            .finally(() => {
                // İşlem başarılı olsa da olmasa da sayfayı yenile
                window.location.reload(); 
            });
        }
    });
</script>
{% endblock %}
</div>
</body>
</html>
                    if (contentType && contentType.indexOf("application/json") !== -1) {
                        return response.json();
                    } else {
                        // Eğer JSON değilse ama başarılıysa, uyarı ver ve yine de sayfayı yenile
                        console.warn("Sunucu yanıtı JSON değil, ancak durum başarılıydı.");
                        return response.text().then(text => ({ success: true, message: "İşlem başarılı, ancak sunucudan JSON yanıtı alınamadı. Ham Yanıt: " + text.substring(0, 100) }));
                    }
                })
                .then(data => {
                    if (data.success) {
                        alert(data.message); // Başarı mesajı
                    } else {
                        alert('Hata: ' + data.message); // Hata mesajı
                    }
                })
                .catch(error => {
                    console.error('Silme işleminde beklenmeyen hata:', error);
                    alert('Silme işlemi sırasında bir hata oluştu: ' + error.message); // Gerçek hata mesajını göster
                })
                .finally(() => {
                    // İşlem başarılı olsa da olmasa da sayfayı yenile
                    window.location.reload(); 
                });
            }
        });
    </script>
</div>
</body>
</html>
