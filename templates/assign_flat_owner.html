{% extends "base.html" %}

{% block title %}Daire Sahibi Ata{% endblock %}

{% block extra_head %}
<style>
    body { padding-top: 76px; }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-7">
        <div class="card">
            <div class="card-header"><h4 class="mb-0">Daire Sahibi Ata</h4></div>
            <div class="card-body">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% for category, msg in messages %}
                        <div class="alert alert-{{category}} small p-2">{{msg}}</div>
                    {% endfor %}
                {% endwith %}

                <form method="POST" id="assignFlatForm">
                    <div class="mb-3">
                        <label for="projectSelect" class="form-label">Proje Seçin</label>
                        <select class="form-select" id="projectSelect" name="project_id" required>
                            <option value="" selected disabled>Proje Seçiniz</option>
                            {% for project in projects %}
                                <option value="{{ project[0] }}">{{ project[1] }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="flatSelect" class="form-label">Daire Seçin</label>
                        <select class="form-select" id="flatSelect" name="flat_id" required disabled>
                            <option value="">Lütfen önce bir proje seçin</option>
                        </select>
                    </div>

                    <hr>

                    <div class="mb-3">
                        <div class="form-check"><input class="form-check-input" type="radio" name="customer_option" id="existingCustomerRadio" value="existing" checked><label class="form-check-label" for="existingCustomerRadio">Mevcut Müşteri Seç</label></div>
                        <div class="form-check"><input class="form-check-input" type="radio" name="customer_option" id="newCustomerRadio" value="new"><label class="form-check-label" for="newCustomerRadio">Yeni Müşteri Ekle</label></div>
                    </div>

                    <div id="existingCustomerFields">
                        <div class="mb-3"><label for="customerSelect" class="form-label">Mevcut Müşteri</label><select class="form-select" id="customerSelect" name="customer_id"><option value="">Müşteri Seçiniz</option>{% for customer in customers %}<option value="{{ customer[0] }}">{{ customer[1] }} {{ customer[2] }}</option>{% endfor %}</select></div>
                    </div>

                    <div id="newCustomerFields" style="display: none;">
                        <div class="mb-2"><label for="new_first_name" class="form-label">Yeni Müşteri Adı</label><input type="text" class="form-control" id="new_first_name" name="new_first_name"></div>
                        <div class="mb-2"><label for="new_last_name" class="form-label">Yeni Müşteri Soyadı</label><input type="text" class="form-control" id="new_last_name" name="new_last_name"></div>
                        <div class="mb-2"><label for="new_phone" class="form-label">Telefon</label><input type="text" class="form-control" id="new_phone" name="new_phone"></div>
                        <div class="mb-2"><label for="new_national_id" class="form-label">TC Kimlik/Vergi No</label><input type="text" class="form-control" id="new_national_id" name="new_national_id"></div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100 mt-3">Sahibi Ata</button>
                </form>
            </div>
        </div>
    </div>
    <div class="col-lg-5">
        <div class="card">
            <div class="card-header"><h4 class="mb-0">Mevcut Daire Sahipleri</h4></div>
            <div class="card-body table-responsive">
                <table class="table table-bordered table-striped table-sm">
                    <thead>
                        <tr>
                            <th>Proje</th>
                            <th>Blok</th>
                            <th>Kat/No</th>
                            <th>Sahip</th>
                            <th>İşlem</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for flat in flats_data %}
                        <tr>
                            <td>{{ flat[1] }}</td>
                            <td>{{ flat[7] or 'N/A' }}</td>
                            <td>{{ flat[3] }}/{{ flat[2] }}</td>
                            <td>{{ flat[4] if flat[4] else 'Sahipsiz' }} {{ flat[5] if flat[5] else '' }}</td>
                            <td>
                                <button class="btn btn-sm btn-danger delete-owner-btn" 
                                        data-flat-id="{{ flat[0] }}"
                                        data-bs-toggle="modal"
                                        data-bs-target="#deleteConfirmationModal">
                                    <i class="fa-solid fa-user-slash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmationModalLabel">Onay Gerekli</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Bu dairenin sahibini ve tüm ilgili ödeme/taksit bilgilerini silmek istediğinizden emin misiniz? Bu işlem geri alınamaz!
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Silmeyi Onayla</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const flatsData = {{ flats_data | tojson }};
    const projectSelect = document.getElementById('projectSelect');
    const flatSelect = document.getElementById('flatSelect');
    const existingCustomerRadio = document.getElementById('existingCustomerRadio');
    const newCustomerRadio = document.getElementById('newCustomerRadio');
    const existingCustomerFields = document.getElementById('existingCustomerFields');
    const newCustomerFields = document.getElementById('newCustomerFields');
    const customerSelect = document.getElementById('customerSelect');
    const newFirstNameInput = document.getElementById('new_first_name');
    const newLastNameInput = document.getElementById('new_last_name');

    function toggleCustomerFields() {
        const isExisting = existingCustomerRadio.checked;
        existingCustomerFields.style.display = isExisting ? 'block' : 'none';
        newCustomerFields.style.display = isExisting ? 'none' : 'block';
        customerSelect.required = isExisting;
        newFirstNameInput.required = !isExisting;
        newLastNameInput.required = !isExisting;
    }
    existingCustomerRadio.addEventListener('change', toggleCustomerFields);
    newCustomerRadio.addEventListener('change', toggleCustomerFields);
    toggleCustomerFields();

    projectSelect.addEventListener('change', function() {
        const selectedProjectName = this.options[this.selectedIndex].text;
        flatSelect.innerHTML = '<option value="" selected disabled>Daire Seçiniz</option>';
        flatSelect.disabled = true;

        if (selectedProjectName) {
            const projectFlats = flatsData.filter(flat => flat[1] === selectedProjectName);
            
            if (projectFlats.length > 0) {
                projectFlats.forEach(flat => {
                    const option = document.createElement('option');
                    option.value = flat[0];
                    const blockName = flat[7] || 'N/A';
                    option.textContent = `Blok: ${blockName}, Kat: ${flat[3]}, No: ${flat[2]}`;
                    
                    if(flat[6] !== null) {
                        option.disabled = true;
                        option.textContent += ` (${flat[4]} ${flat[5]})`;
                    }
                    flatSelect.appendChild(option);
                });
                flatSelect.disabled = false;
            } else {
                flatSelect.innerHTML = '<option value="">Bu projede daire bulunmuyor</option>';
            }
        }
    });

    const deleteConfirmationModalEl = document.getElementById('deleteConfirmationModal');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    let flatIdToDelete = null;

    deleteConfirmationModalEl.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        flatIdToDelete = button.getAttribute('data-flat-id');
    });

    confirmDeleteBtn.addEventListener('click', function() {
        if (flatIdToDelete) {
            fetch('/delete_flat_owner_data', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ flat_id: flatIdToDelete }),
            }).then(response => {
                if(response.ok) {
                    window.location.reload();
                } else {
                    alert("Silme işlemi sırasında bir sunucu hatası oluştu.");
                }
            });
        }
    });
</script>
{% endblock %}