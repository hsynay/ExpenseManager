{% extends "base.html" %}

{% block title %}{{ project_name }} - Kasa Defteri{% endblock %}

{% block extra_head %}
<style>
    .summary-card h6 { font-size: 0.8rem; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold mb-0"><i class="fa-solid fa-book me-2 text-primary"></i>Kasa Defteri</h2>
        <p class="text-muted fs-5">{{ project_name }}</p>
    </div>
    <div>
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
            <i class="fa-solid fa-arrow-left me-1"></i>Geri
        </a>
    </div>
</div>

<!-- === YENİ VE DOĞRU ÖZET KARTI === -->
<div class="card summary-card mb-4">
    <div class="card-body text-center p-3">
        <div class="row">
            <div class="col-md-4 border-end">
                <h6 class="text-muted mb-1">GERÇEKLEŞEN TOPLAM GELİR</h6>
                <h4 class="fw-bold text-success mb-0">{{ total_realized_income|thousands }} ₺</h4>
            </div>
            <div class="col-md-4 border-end">
                <h6 class="text-muted mb-1">GERÇEKLEŞEN TOPLAM GİDER</h6>
                <h4 class="fw-bold text-danger mb-0">{{ total_realized_expense|thousands }} ₺</h4>
            </div>
            <div class="col-md-4">
                <h6 class="text-muted mb-1">NET NAKİT DURUMU (KASA)</h6>
                <h4 class="fw-bold {{ 'text-success' if net_cash_flow >= 0 else 'text-danger' }} mb-0">{{ net_cash_flow|thousands }} ₺</h4>
            </div>
        </div>
    </div>
</div>
<!-- === ÖZET KARTI SONU === -->

<form method="get" class="mb-4">
    <div class="row g-2 align-items-center">
        <div class="col-md-4">
            <label class="form-label fw-bold mb-1">Görüntüle:</label>
            <select name="view" class="form-select" onchange="this.form.submit()">
                <option value="all" {% if view_type == 'all' %}selected{% endif %}>Tümü (Gerçekleşen Gelir ve Giderler)</option>
                <option value="income" {% if view_type == 'income' %}selected{% endif %}>Sadece Gerçekleşen Gelirler</option>
                <option value="expense" {% if view_type == 'expense' %}selected{% endif %}>Sadece Gerçekleşen Giderler</option>
            </select>
        </div>
    </div>
</form>

{% if view_type in ['all', 'income'] %}
<div class="card mb-4">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0"><i class="fa-solid fa-arrow-down me-2"></i>Gerçekleşen Gelirler</h5>
    </div>
    <div class="card-body table-responsive p-0">
        <!-- id eklendi: income-realized-table -->
        <table id="income-realized-table" class="table table-striped table-hover table-sm mb-0">
            <thead>
                <tr>
                    <!-- Tarih başlığı tıklanabilir, ikon ve dataset.order eklendi -->
                    <th>
                        <a id="income-sort-date" class="text-dark" data-order="asc" href="#">
                            Tarih <i class="fa-solid fa-sort" id="income-sort-date-icon"></i>
                        </a>
                    </th>
                    <!-- Kimden başlığı tıklanabilir -->
                    <th>
                        <a id="income-sort-party" class="text-dark" data-order="asc" href="#">
                            Kimden <i class="fa-solid fa-sort" id="income-sort-party-icon"></i>
                        </a>
                    </th>
                    <!-- Daire artık tıklanabilir -->
                    <th>
                        <a id="income-sort-flat" class="text-dark" data-order="asc" href="#">
                            Daire <i class="fa-solid fa-sort" id="income-sort-flat-icon"></i>
                        </a>
                    </th>
                    <th>Açıklama</th>
                    <!-- Yöntem artık tıklanabilir -->
                    <th>
                        <a id="income-sort-method" class="text-dark" data-order="asc" href="#">
                            Yöntem <i class="fa-solid fa-sort" id="income-sort-method-icon"></i>
                        </a>
                    </th>
                    <th class="text-end">
                        <a id="income-sort-amount" class="text-dark" data-order="asc" href="#">
                            Tutar <i class="fa-solid fa-sort" id="income-sort-amount-icon"></i>
                        </a>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for date, desc, amount, method, first, last, block, floor, flat_no in income_data %}
                <tr>
                    <td>{{ date.strftime('%d.%m.%Y') }}</td>
                    <td>{{ (first or '') ~ ' ' ~ (last or '') }}</td>
                    <td>Blok: {{ block or 'N/A' }}, Kat: {{ floor }}, No: {{ flat_no }}</td>
                    <td>{{ desc or '-' }}</td>
                    <td>
                        {% if method == 'çek' %}
                            <span class="badge bg-info text-dark"><i class="fa-solid fa-money-check-dollar me-1"></i> Çek</span>
                        {% else %}
                            <span class="badge bg-success"><i class="fa-solid fa-money-bill me-1"></i> Nakit</span>
                        {% endif %}
                    </td>
                    <td class="text-end text-success fw-bold">{{ amount|thousands }} ₺</td>
                </tr>
                {% else %}
                <tr><td colspan="6" class="text-center text-muted p-3">Bu projeye ait gerçekleşmiş gelir kaydı yok.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

{% if view_type in ['all', 'expense'] %}
<div class="card">
    <div class="card-header bg-danger text-white">
        <h5 class="mb-0"><i class="fa-solid fa-arrow-up me-2"></i>Gerçekleşen Giderler</h5>
    </div>
    <div class="card-body table-responsive p-0">
        <!-- id eklendi: expense-realized-table -->
        <table id="expense-realized-table" class="table table-striped table-hover table-sm mb-0">
            <thead>
                <tr>
                    <!-- Tarih başlığı tıklanabilir -->
                    <th>
                        <a id="expense-sort-date" class="text-dark" data-order="asc" href="#">
                            Tarih <i class="fa-solid fa-sort" id="expense-sort-date-icon"></i>
                        </a>
                    </th>
                    <th>Başlık / Açıklama</th>
                    <!-- Kime / Nereye başlığı tıklanabilir -->
                    <th>
                        <a id="expense-sort-party" class="text-dark" data-order="asc" href="#">
                            Kime / Nereye <i class="fa-solid fa-sort" id="expense-sort-party-icon"></i>
                        </a>
                    </th>
                    <!-- Yöntem tıklanabilir -->
                    <th>
                        <a id="expense-sort-method" class="text-dark" data-order="asc" href="#">
                            Yöntem <i class="fa-solid fa-sort" id="expense-sort-method-icon"></i>
                        </a>
                    </th>
                    <th class="text-end">
                        <a id="expense-sort-amount" class="text-dark" data-order="asc" href="#">
                            Tutar <i class="fa-solid fa-sort" id="expense-sort-amount-icon"></i>
                        </a>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for date, title, party_name, description, method, amount, type in expense_data %}
                <tr>
                    <td>{{ date.strftime('%d.%m.%Y') }}</td>
                    <td>
                        <div class="fw-bold">{{ title }}</div>
                        <div class="text-muted small">{{ description or '-' }}</div>
                    </td>
                    <td>
                        <div class="fw-bold">{{ party_name or '-' }}</div>
                        <div class="text-muted small">{{ type }}</div>
                    </td>
                    <td>
                        {% if method == 'çek' %}
                            <span class="badge bg-info text-dark"><i class="fa-solid fa-money-check-dollar me-1"></i> Çek</span>
                        {% else %}
                            <span class="badge bg-danger"><i class="fa-solid fa-money-bill me-1"></i> Nakit</span>
                        {% endif %}
                    </td>
                    <td class="text-end text-danger fw-bold">{{ amount|thousands }} ₺</td>
                </tr>
                {% else %}
                <tr><td colspan="5" class="text-center text-muted p-3">Bu projeye ait gerçekleşmiş gider kaydı yok.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- JavaScript: Tarih, metin, daire-no ve sayı (tutar) sütunları için istemci tarafı sıralama -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Yardımcı: dd.mm.yyyy -> Date
    function parseDateDMY(text) {
        var parts = (text || '').trim().split('.');
        if (parts.length !== 3) return new Date(0);
        var d = parseInt(parts[0], 10), m = parseInt(parts[1], 10) - 1, y = parseInt(parts[2], 10);
        return new Date(y, m, d);
    }

    // Para metnini sayıya çevir (ör: "1.234.567 ₺" -> 1234567)
    function parseAmount(text) {
        var s = (text || '').trim();
        s = s.replace(/[^\d\.,\-]/g, '');
        s = s.replace(/\./g, '').replace(/,/g, '.');
        var n = parseFloat(s);
        return isNaN(n) ? 0 : n;
    }

    // Daire hücresinden "No: X" veya "No X" şeklindeki numarayı ayıkla
    function parseFlatNumber(text) {
        var s = (text || '').trim();
        var m = s.match(/No[:\s]*([0-9]+)/i);
        if (m && m[1]) return parseInt(m[1], 10);
        // alternatif: "No" olmayabilir, dene son "No:" yerine son sayı
        var m2 = s.match(/(\d+)\s*$/);
        if (m2 && m2[1]) return parseInt(m2[1], 10);
        return 0;
    }

    // Genel attach fonksiyonu: tableId, linkId, colIndex, type ('text'|'date'|'number'|'flat')
    function attachSort(linkId, tableId, colIndex, type) {
        var link = document.getElementById(linkId);
        var table = document.getElementById(tableId);
        if (!link || !table) return;
        var icon = link.querySelector('i');
        link.style.cursor = 'pointer';
        link.addEventListener('click', function (e) {
            e.preventDefault();
            var tbody = table.tBodies[0];
            if (!tbody) return;
            var rows = Array.prototype.slice.call(tbody.querySelectorAll('tr'));
            var currentOrder = (link.dataset.order || 'asc').toLowerCase();
            var newOrder = currentOrder === 'asc' ? 'desc' : 'asc';

            rows.sort(function (a, b) {
                var aCell = a.cells[colIndex] ? a.cells[colIndex].textContent.trim() : '';
                var bCell = b.cells[colIndex] ? b.cells[colIndex].textContent.trim() : '';
                var cmp = 0;
                if (type === 'date') {
                    cmp = parseDateDMY(aCell) - parseDateDMY(bCell);
                } else if (type === 'number') {
                    cmp = parseAmount(aCell) - parseAmount(bCell);
                } else if (type === 'flat') {
                    cmp = parseFlatNumber(aCell) - parseFlatNumber(bCell);
                } else { // 'text'
                    cmp = aCell.localeCompare(bCell, 'tr');
                }
                return newOrder === 'asc' ? cmp : -cmp;
            });

            rows.forEach(function (r) { tbody.appendChild(r); });
            link.dataset.order = newOrder;
            if (icon) {
                icon.className = newOrder === 'asc' ? 'fa-solid fa-sort-up' : 'fa-solid fa-sort-down';
            }
        });
    }

    // Income table: Tarih (col 0, date), Kimden (col 1, text), Daire (col 2, flat), Yöntem (col 4, text), Tutar (col 5, number)
    attachSort('income-sort-date', 'income-realized-table', 0, 'date');
    attachSort('income-sort-party', 'income-realized-table', 1, 'text');
    attachSort('income-sort-flat', 'income-realized-table', 2, 'flat');
    attachSort('income-sort-method', 'income-realized-table', 4, 'text');
    attachSort('income-sort-amount', 'income-realized-table', 5, 'number');

    // Expense table: Tarih (col 0, date), Kime / Nereye (col 2, text), Yöntem (col 3, text), Tutar (col 4, number)
    attachSort('expense-sort-date', 'expense-realized-table', 0, 'date');
    attachSort('expense-sort-party', 'expense-realized-table', 2, 'text');
    attachSort('expense-sort-method', 'expense-realized-table', 3, 'text');
    attachSort('expense-sort-amount', 'expense-realized-table', 4, 'number');
});
</script>

{% endblock %}