{% extends "base.html" %}

{% block title %}{{ project_name }} - Kasa Defteri{% endblock %}

{% block extra_head %}
<style>
    .summary-card h6 { font-size: 0.8rem; }
    /* Sıralanabilir başlıklar için imleç */
    th a { cursor: pointer; text-decoration: none; }
    th a:hover { text-decoration: underline; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold mb-0"><i class="fa-solid fa-book me-2 text-primary"></i>Kasa Defteri</h2>
        <p class="text-muted fs-5">{{ project_name }}</p>
    </div>
    <div>
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
            <i class="fa-solid fa-arrow-left me-1"></i>Geri
        </a>
    </div>
</div>

<div class="card summary-card mb-4">
    <div class="card-body text-center p-3">
        <div class="row">
            <div class="col-md-4 border-end">
                <h6 class="text-muted mb-1">GERÇEKLEŞEN TOPLAM GELİR</h6>
                <h4 class="fw-bold text-success mb-0">{{ total_realized_income|thousands }} ₺</h4>
            </div>
            <div class="col-md-4 border-end">
                <h6 class="text-muted mb-1">GERÇEKLEŞEN TOPLAM GİDER</h6>
                <h4 class="fw-bold text-danger mb-0">{{ total_realized_expense|thousands }} ₺</h4>
            </div>
            <div class="col-md-4">
                <h6 class="text-muted mb-1">NET NAKİT DURUMU (KASA)</h6>
                <h4 class="fw-bold {{ 'text-success' if net_cash_flow >= 0 else 'text-danger' }} mb-0">{{ net_cash_flow|thousands }} ₺</h4>
            </div>
        </div>
    </div>
</div>
<form method="get" class="mb-4">
    <div class="row g-2 align-items-center">
        <div class="col-md-4">
            <label class="form-label fw-bold mb-1">Görüntüle:</label>
            <select name="view" class="form-select" onchange="this.form.submit()">
                <option value="all" {% if view_type == 'all' %}selected{% endif %}>Tümü (Gerçekleşen Gelir ve Giderler)</option>
                <option value="income" {% if view_type == 'income' %}selected{% endif %}>Sadece Gerçekleşen Gelirler</option>
                <option value="expense" {% if view_type == 'expense' %}selected{% endif %}>Sadece Gerçekleşen Giderler</option>
            </select>
        </div>
    </div>
</form>

{% if view_type in ['all', 'income'] %}
<div class="card mb-4">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0"><i class="fa-solid fa-arrow-down me-2"></i>Gerçekleşen Gelirler</h5>
    </div>
    <div class="card-body table-responsive p-0">
        <table id="income-realized-table" class="table table-striped table-hover table-sm mb-0">
            <thead>
                <tr>
                    <th>
                        <a id="income-sort-date" class="text-dark" data-order="asc" href="#">
                            Tarih <i class="fa-solid fa-sort" id="income-sort-date-icon"></i>
                        </a>
                    </th>
                    <th>
                        <a id="income-sort-party" class="text-dark" data-order="asc" href="#">
                            Kimden <i class="fa-solid fa-sort" id="income-sort-party-icon"></i>
                        </a>
                    </th>
                    <th>
                        <a id="income-sort-flat" class="text-dark" data-order="asc" href="#">
                            Daire <i class="fa-solid fa-sort" id="income-sort-flat-icon"></i>
                        </a>
                    </th>
                    <th>Açıklama</th>
                    <th>
                        <a id="income-sort-method" class="text-dark" data-order="asc" href="#">
                            Yöntem <i class="fa-solid fa-sort" id="income-sort-method-icon"></i>
                        </a>
                    </th>
                    <th class="text-end">
                        <a id="income-sort-amount" class="text-dark" data-order="asc" href="#">
                            Tutar <i class="fa-solid fa-sort" id="income-sort-amount-icon"></i>
                        </a>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for date, desc, amount, method, first, last, block, floor, flat_no in income_data %}
                <tr>
                    <td>{{ date.strftime('%d.%m.%Y') }}</td>
                    <td>{{ (first or '') ~ ' ' ~ (last or '') }}</td>
                    <td>Blok: {{ block or 'N/A' }}, Kat: {{ floor }}, No: {{ flat_no }}</td>
                    <td>{{ desc or '-' }}</td>
                    <td>
                        {% if method == 'çek' %}
                            <span class="badge bg-info text-dark"><i class="fa-solid fa-money-check-dollar me-1"></i> Çek</span>
                        {% else %}
                            <span class="badge bg-success"><i class="fa-solid fa-money-bill me-1"></i> Nakit</span>
                        {% endif %}
                    </td>
                    <td class="text-end text-success fw-bold">{{ amount|thousands }} ₺</td>
                </tr>
                {% else %}
                <tr><td colspan="6" class="text-center text-muted p-3">Bu projeye ait gerçekleşmiş gelir kaydı yok.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

{% if view_type in ['all', 'expense'] %}
<div class="card">
    <div class="card-header bg-danger text-white">
        <h5 class="mb-0"><i class="fa-solid fa-arrow-up me-2"></i>Gerçekleşen Giderler</h5>
    </div>
    <div class="card-body table-responsive p-0">
         <table id="expense-realized-table" class="table table-striped table-hover table-sm mb-0">
            <thead>
                <tr>
                    <th>
                        <a id="expense-sort-date" class="text-dark" data-order="asc" href="#">
                            Tarih <i class="fa-solid fa-sort" id="expense-sort-date-icon"></i>
                        </a>
                    </th>
                    <th>Başlık / Açıklama</th>
                    <th>
                        <a id="expense-sort-party" class="text-dark" data-order="asc" href="#">
                            Kime / Nereye <i class="fa-solid fa-sort" id="expense-sort-party-icon"></i>
                        </a>
                    </th>
                    <th>
                        <a id="expense-sort-method" class="text-dark" data-order="asc" href="#">
                            Yöntem <i class="fa-solid fa-sort" id="expense-sort-method-icon"></i>
                        </a>
                    </th>
                    <th class="text-end">
                        <a id="expense-sort-amount" class="text-dark" data-order="asc" href="#">
                            Tutar <i class="fa-solid fa-sort" id="expense-sort-amount-icon"></i>
                        </a>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for date, title, party_name, description, method, amount, type in expense_data %}
                <tr>
                    <td>{{ date.strftime('%d.%m.%Y') }}</td>
                    <td>
                        <div class="fw-bold">{{ title }}</div>
                        <div class="text-muted small">{{ description or '-' }}</div>
                    </td>
                    <td>
                        <div class="fw-bold">{{ party_name or '-' }}</div>
                        <div class="text-muted small">{{ type }}</div>
                    </td>
                    <td>
                        {% if method == 'çek' %}
                            <span class="badge bg-info text-dark"><i class="fa-solid fa-money-check-dollar me-1"></i> Çek</span>
                        {% else %}
                            <span class="badge bg-danger"><i class="fa-solid fa-money-bill me-1"></i> Nakit</span>
                        {% endif %}
                    </td>
                    <td class="text-end text-danger fw-bold">{{ amount|thousands }} ₺</td>
                </tr>
                {% else %}
                <tr><td colspan="5" class="text-center text-muted p-3">Bu projeye ait gerçekleşmiş gider kaydı yok.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Yardımcı: dd.mm.yyyy -> Date
    function parseDateDMY(text) {
        var parts = (text || '').trim().split('.');
        if (parts.length !== 3) return new Date(0); // Geçersiz tarih için başlangıç tarihi
        // Parçaları tamsayıya çevir: gün, ay (0-11 arası), yıl
        var d = parseInt(parts[0], 10), m = parseInt(parts[1], 10) - 1, y = parseInt(parts[2], 10);
        // Yeni Date nesnesi oluştur
        return new Date(y, m, d);
    }

    // Para metnini sayıya çevir (ör: "1.234.567 ₺" -> 1234567)
    function parseAmount(text) {
        var s = (text || '').trim();
        // Para birimi, boşluk gibi sayısal olmayan karakterleri kaldır
        s = s.replace(/[^\d\.,\-]/g, '');
        // Binlik ayıracı olan noktaları kaldır, ondalık ayıracı olan virgülü nokta ile değiştir
        s = s.replace(/\./g, '').replace(/,/g, '.');
        // Metni ondalık sayıya çevir
        var n = parseFloat(s);
        // Eğer çevirme başarısız olursa 0 döndür, aksi halde sayıyı döndür
        return isNaN(n) ? 0 : n;
    }

    // Daire hücresinden daire numarasını ayıkla (Örn: "Blok: A, Kat: 1, No: 5" -> 5)
    function parseFlatNumber(text) {
        var s = (text || '').trim();
        // "No: X" veya "No X" formatını ara
        var match = s.match(/No[:\s]*(\d+)/i);
        // Eğer eşleşme bulunursa ve sayı grubu varsa, sayıyı tamsayıya çevirip döndür
        if (match && match[1]) {
            return parseInt(match[1], 10);
        }
        // Alternatif: Satır sonundaki sayıyı bulmaya çalış (eğer "No:" yoksa)
        var matchEnd = s.match(/(\d+)$/);
        if (matchEnd && matchEnd[1]) {
             return parseInt(matchEnd[1], 10);
        }
        // Hiçbir sayı bulunamazsa 0 döndür
        return 0;
    }

    // Genel sıralama fonksiyonu: Tıklanan başlığa sıralama işlevi ekler
    // linkId: Tıklanan başlık `<a>` etiketinin ID'si
    // tableId: Sıralanacak tablonun ID'si
    // colIndex: Sıralanacak sütunun indeksi (0'dan başlar)
    // type: Sütun veri tipi ('date', 'number', 'flat', 'text')
    function attachSort(linkId, tableId, colIndex, type) {
        var link = document.getElementById(linkId); // Başlık linkini al
        var table = document.getElementById(tableId); // Tabloyu al
        // Eğer link veya tablo bulunamazsa fonksiyondan çık
        if (!link || !table) return;
        var icon = link.querySelector('i'); // Sıralama ikonunu al

        // Linke tıklandığında çalışacak fonksiyonu tanımla
        link.addEventListener('click', function (e) {
            e.preventDefault(); // Linkin normal davranışını engelle (sayfa yenilemesini durdur)
            var tbody = table.tBodies[0]; // Tablonun tbody bölümünü al
            // Eğer tbody yoksa fonksiyondan çık
            if (!tbody) return;

            // tbody içindeki tüm satırları (tr) alıp bir diziye dönüştür
            var rows = Array.prototype.slice.call(tbody.querySelectorAll('tr'));
            // Mevcut sıralama yönünü linkin 'data-order' özelliğinden al (varsayılan 'asc')
            var currentOrder = link.dataset.order || 'asc';
            // Yeni sıralama yönünü belirle (mevcut 'asc' ise 'desc' yap, değilse 'asc' yap)
            var newOrder = currentOrder === 'asc' ? 'desc' : 'asc';

            // Satırları sırala
            rows.sort(function (a, b) {
                // İki satırın ilgili sütunlarındaki metin içeriklerini al
                var aText = a.cells[colIndex] ? a.cells[colIndex].textContent.trim() : '';
                var bText = b.cells[colIndex] ? b.cells[colIndex].textContent.trim() : '';
                var comparison = 0; // Karşılaştırma sonucu (varsayılan 0)

                // Veri tipine göre karşılaştırma yap
                if (type === 'date') {
                    comparison = parseDateDMY(aText) - parseDateDMY(bText); // Tarihleri karşılaştır
                } else if (type === 'number') {
                    comparison = parseAmount(aText) - parseAmount(bText); // Sayıları karşılaştır
                } else if (type === 'flat') {
                    comparison = parseFlatNumber(aText) - parseFlatNumber(bText); // Daire numaralarını karşılaştır
                } else { // 'text'
                    comparison = aText.localeCompare(bText, 'tr'); // Metinleri Türkçe karakter setine göre karşılaştır
                }
                // Yeni sıralama yönüne göre sonucu ayarla ('desc' ise ters çevir)
                return newOrder === 'asc' ? comparison : -comparison;
            });

            // Sıralanmış satırları tekrar tbody'ye ekle (bu işlem DOM'da sırayı günceller)
            rows.forEach(function(row) {
                tbody.appendChild(row);
            });

            // Linkin 'data-order' özelliğini yeni sıralama yönü ile güncelle
            link.dataset.order = newOrder;
            // İkonun sınıfını yeni sıralama yönüne göre güncelle (yukarı/aşağı ok)
            if (icon) {
                icon.className = 'fa-solid ' + (newOrder === 'asc' ? 'fa-sort-up' : 'fa-sort-down');
            }

            // Diğer tüm başlık ikonlarını varsayılan 'fa-sort' ikonuna döndür
            var allHeaders = table.querySelectorAll('thead th a i');
            allHeaders.forEach(function(otherIcon){
                if(otherIcon !== icon) { // Şu anki ikon dışındakiler
                    otherIcon.className = 'fa-solid fa-sort';
                }
            });
             // Diğer tüm başlıkların data-order'ını sıfırla
            var allLinks = table.querySelectorAll('thead th a');
             allLinks.forEach(function(otherLink){
                 if(otherLink !== link) {
                     otherLink.dataset.order = 'asc'; // Veya varsayılan neyse o
                 }
             });
        });
    }

    // Gelir Tablosu İçin Sıralama Fonksiyonlarını Çağır
    // Parametreler: linkId, tableId, columnIndex, dataType
    attachSort('income-sort-date', 'income-realized-table', 0, 'date');
    attachSort('income-sort-party', 'income-realized-table', 1, 'text');
    attachSort('income-sort-flat', 'income-realized-table', 2, 'flat'); // Daire no için 'flat' tipi
    attachSort('income-sort-method', 'income-realized-table', 4, 'text');
    attachSort('income-sort-amount', 'income-realized-table', 5, 'number');

    // Gider Tablosu İçin Sıralama Fonksiyonlarını Çağır
    // Parametreler: linkId, tableId, columnIndex, dataType
    attachSort('expense-sort-date', 'expense-realized-table', 0, 'date');
    attachSort('expense-sort-party', 'expense-realized-table', 2, 'text'); // Kime/Nereye
    attachSort('expense-sort-method', 'expense-realized-table', 3, 'text');
    attachSort('expense-sort-amount', 'expense-realized-table', 4, 'number');
});
</script>

{% endblock %}